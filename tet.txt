#!/bin/ksh

echo "{"
echo "  \"data\":["

YEAR_AGO=$(perl -e 'print time() - 365*24*3600, "\n"')

FIRST=1

lsuser -c -a id ALL | grep -v '^#' | cut -d= -f2,1 | perl -e '
use strict;
use warnings;

my $year_ago = $ENV{YEAR_AGO};
my $first=1;

while (<>) {
    chomp;
    my ($uid, $user) = split(/:/, $_);
    next unless $uid =~ /^\d+$/;

    my $ts = `lsuser -a time_last_login $user 2>/dev/null`;
    chomp($ts);
    $ts =~ s/time_last_login=//;
    next unless $ts =~ /^\d+$/;  # pomijamy nieaktywnych

    next if $ts < $year_ago;

    if ($first==0) { print ",\n"; }
    print "    { \"{#USERNAME}\":\"$user\" }";
    $first=0;
}
print "\n";
'

echo "  ]"
echo "}"
